<!DOCTYPE html>
<html>
	<head>
	</head>
	<body onload="startGame()">
		<canvas id="game area" width="400" height="400" style="border:1px solid #c3c3c3;">
		</canvas>
		<p id="lives"></p>
		<p id="wave number"></p>
		<script type="text/javascript" src="entities.js"></script>
		<script>
			const startGame = () => {
				theGame.start();
			}

			let player = {
				xPos: 200,
				yPos: 200,
				vX: 0,
				vY: 0,
				reload: 10,
				cooldown: 0,
				damage: 1,
				lives: 3
			}
			let keys = {
				87: false,
				65: false,
				83: false,
				68: false
				
			}
			let mouse = {
				x: 0,
				y: 0
				
			}
			let bullets = [];
			let enemies = [];
			let waves = 0;
			let wavenum = 0;
			
			const theGame = {
				canvas : document.getElementById("game area"),
				start : function() {
					this.canvas.width = 400;
					this.canvas.height = 400;
					this.context = this.canvas.getContext("2d");
					this.interval = setInterval(updateGame, 20);
					window.addEventListener("mousedown", function (e) {
						mouse.down = true;
						let margin = document.getElementById("game area").getBoundingClientRect();
						mouse.x = e.clientX - margin.left;
						mouse.y = e.clientY - margin.top;
					})
					window.addEventListener("mouseup", function (e) {
						mouse.down = false;
						
					})
					window.addEventListener('keydown', function (e) {
							e.preventDefault();
							keys[e.keyCode] = true;
						})
					window.addEventListener('keyup', function (e) {
						keys[e.keyCode] = false;
					})
				},
				stop : function() {
					clearInterval(this.interval);
				},
				clear : function() {
					this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
				}
			}
			const updateGame = () => {
				theGame.clear();
				if (keys[87]) {
					if(player.vY < -5) {
						player.vY = -5
					} else {
					   player.vY -= 0.1;
					}
				} 
				if (keys[65]) {
					if(player.vX < -5) {
						player.vX = -5
					} else {
					   player.vX -= 0.1;
					}
				} 
				if (keys[83]) {
					if(player.vY > 5) {
						player.vY = 5
					} else {
					   player.vY += 0.1;
					}
				}
				if (keys[68]) {
					if(player.vX > 5) {
						player.vX = 5
					} else {
					   player.vX += 0.1;
					}
				}
				if (player.xPos < 0) {
					player.xPos = 0;
					player.vX = -player.vX * 1/2;
				}
				if (player.xPos > 400) {
					player.xPos = 400;
					player.vX = -player.vX * 1/2;
				}
				if (player.yPos < 0) {
					player.yPos = 0;
					player.vY = -player.vY * 1/2;
				}
				if (player.yPos > 400) {
					player.yPos = 400;
					player.vY = -player.vY * 1/2;
				}
				player.cooldown++;
				if (mouse.down === true) {
					window.addEventListener("mousemove", function (e) {
						let margin = document.getElementById("game area").getBoundingClientRect();
						mouse.x = e.clientX - margin.left;
						mouse.y = e.clientY - margin.top;
					})
					if(player.cooldown >= player.reload) {
						let angle = Math.atan2(player.xPos-mouse.x,player.yPos-mouse.y); 
						bullets.push(new Bullet(player.xPos,player.yPos,-Math.sin(angle)*7.5,-Math.cos(angle)*7.5));
						player.cooldown = 0;
					}
				}
				player.xPos += player.vX;
				player.yPos += player.vY;
				
				entityUpdate();
				update();
			}
			const update = () => {
				let wavestop = false;
				for(let i = 0; i < enemies.length; i++) {
					if(enemies[i].stopwaves === true) {
						wavestop = true;
					}
				}
				waves++;
				if(waves > 300 && wavestop === false) {
					wave();
					waves = 0;
				}
				let canvas = theGame.canvas;
				let shapes = canvas.getContext("2d");
				shapes.fillStyle = "#000000";
				shapes.beginPath();
				shapes.arc(player.xPos,player.yPos,10,0,2*Math.PI);
				shapes.stroke();
				shapes.closePath();
				for(let i = 0; i < bullets.length; i++) {
					if(bullets[i].dead !== true) {
						shapes.beginPath();
						shapes.arc(bullets[i].xPos,bullets[i].yPos,2.5,0,2*Math.PI);
						shapes.stroke();
						shapes.closePath();
					}
				}
				for(let i = 0; i < enemies.length; i++) {
					if(enemies[i].dead !== true) {
						
						if(enemies[i].name === "crasher") {
							enemies[i].angle = Math.atan2((enemies[i].yPos-player.yPos),(enemies[i].xPos-player.xPos));
							let x = enemies[i].xPos;
							let y = enemies[i].yPos;
							let angle = enemies[i].angle;
							let side = 5;
							
							let xlength = -Math.cos(angle)*side + x;
							let ylength = -Math.sin(angle)*side + y;
							let xlength2 = -Math.cos(angle+2*Math.PI/3)*side + x;
							let ylength2 = -Math.sin(angle+2*Math.PI/3)*side + y;
							let xlength3 = -Math.cos(angle+4*Math.PI/3)*side + x;
							let ylength3 = -Math.sin(angle+4*Math.PI/3)*side + y;
							shapes.beginPath();
							shapes.moveTo(xlength,ylength);
							shapes.lineTo(xlength2,ylength2);
							shapes.lineTo(xlength3,ylength3);
							shapes.lineTo(xlength,ylength);
							shapes.stroke();
							shapes.closePath();
						}
						if(enemies[i].name === "big crasher") {
							enemies[i].angle = Math.atan2((enemies[i].yPos-player.yPos),(enemies[i].xPos-player.xPos));
							let x = enemies[i].xPos;
							let y = enemies[i].yPos;
							let angle = enemies[i].angle;
							let side = 15;
							
							let xlength = -Math.cos(angle)*side + x;
							let ylength = -Math.sin(angle)*side + y;
							let xlength2 = -Math.cos(angle+2*Math.PI/3)*side + x;
							let ylength2 = -Math.sin(angle+2*Math.PI/3)*side + y;
							let xlength3 = -Math.cos(angle+4*Math.PI/3)*side + x;
							let ylength3 = -Math.sin(angle+4*Math.PI/3)*side + y;
							shapes.beginPath();
							shapes.moveTo(xlength,ylength);
							shapes.lineTo(xlength2,ylength2);
							shapes.lineTo(xlength3,ylength3);
							shapes.lineTo(xlength,ylength);
							shapes.stroke();
							shapes.closePath();
						}
						if(enemies[i].name === "splitter") {
							enemies[i].angle += Math.PI/30;
							let x = enemies[i].xPos;
							let y = enemies[i].yPos;
							let angle = enemies[i].angle;
							let side = 10;
							
							let xlength = -Math.cos(angle)*side + x;
							let ylength = -Math.sin(angle)*side + y;
							let xlength2 = -Math.cos(angle+1*Math.PI/3)*side + x;
							let ylength2 = -Math.sin(angle+1*Math.PI/3)*side + y;
							let xlength3 = -Math.cos(angle+2*Math.PI/3)*side + x;
							let ylength3 = -Math.sin(angle+2*Math.PI/3)*side + y;
							let xlength4 = -Math.cos(angle+3*Math.PI/3)*side + x;
							let ylength4 = -Math.sin(angle+3*Math.PI/3)*side + y;
							let xlength5 = -Math.cos(angle+4*Math.PI/3)*side + x;
							let ylength5 = -Math.sin(angle+4*Math.PI/3)*side + y;
							let xlength6 = -Math.cos(angle+5*Math.PI/3)*side + x;
							let ylength6 = -Math.sin(angle+5*Math.PI/3)*side + y;
							shapes.beginPath();
							shapes.moveTo(x,y);
							shapes.lineTo(xlength,ylength);
							shapes.lineTo(xlength2,ylength2);
							shapes.moveTo(x,y);
							shapes.lineTo(xlength2,ylength2);
							shapes.lineTo(xlength3,ylength3);
							shapes.moveTo(x,y);
							shapes.lineTo(xlength3,ylength3);
							shapes.lineTo(xlength4,ylength4);
							shapes.moveTo(x,y);
							shapes.lineTo(xlength4,ylength4);
							shapes.lineTo(xlength5,ylength5);
							shapes.moveTo(x,y);
							shapes.lineTo(xlength5,ylength5);
							shapes.lineTo(xlength6,ylength6);
							shapes.moveTo(x,y);
							shapes.lineTo(xlength6,ylength6);
							shapes.lineTo(xlength,ylength);
							shapes.stroke();
							shapes.closePath();
						}
						if(enemies[i].name === "spawner boss") {
							shapes.beginPath();
							shapes.moveTo(0,380);
							shapes.lineTo(400,380);
							shapes.moveTo(400*(enemies[i].health/200),380);
							shapes.lineTo(400*(enemies[i].health/200),400);
							shapes.stroke();
							shapes.closePath;
							
							let x = enemies[i].xPos;
							let y = enemies[i].yPos;
							enemies[i].angle = -Math.atan2((enemies[i].yPos-player.yPos),(enemies[i].xPos-player.xPos))+Math.PI;
							let angle = enemies[i].angle;

							let x1 = Math.sin(angle)*-10+x;
							let y1 = Math.cos(angle)*-10+y;
							let x2 = Math.sin(angle)*10+x;
							let y2 = Math.cos(angle)*10+y;
							let x3 = Math.sin(angle+Math.atan2(20,10))*(Math.sqrt(Math.pow(10,2)+Math.pow(20,2)))+x;
							let y3 = Math.cos(angle+Math.atan2(20,10))*(Math.sqrt(Math.pow(10,2)+Math.pow(20,2)))+y;
							let x4 = Math.sin(angle+Math.atan2(20,30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+x;
							let y4 = Math.cos(angle+Math.atan2(20,30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+y;
							let x5 = Math.sin(angle+Math.atan2(-20,30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+x;
							let y5 = Math.cos(angle+Math.atan2(-20,30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+y;
							let x6 = Math.sin(angle+Math.atan2(-20,-30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+x;
							let y6 = Math.cos(angle+Math.atan2(-20,-30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+y;
							let x7 = Math.sin(angle+Math.atan2(20,-30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+x;
							let y7 = Math.cos(angle+Math.atan2(20,-30))*(Math.sqrt(Math.pow(30,2)+Math.pow(20,2)))+y;
							let x8 = Math.sin(angle+Math.atan2(20,-10))*(Math.sqrt(Math.pow(10,2)+Math.pow(20,2)))+x;
							let y8 = Math.cos(angle+Math.atan2(20,-10))*(Math.sqrt(Math.pow(10,2)+Math.pow(20,2)))+y;
							
							shapes.beginPath();
							shapes.moveTo(x1,y1);
							shapes.lineTo(x2,y2);
							shapes.lineTo(x3,y3);
							shapes.lineTo(x4,y4);
							shapes.lineTo(x5,y5);
							shapes.lineTo(x6,y6);
							shapes.lineTo(x7,y7);
							shapes.lineTo(x8,y8);
							shapes.lineTo(x1,y1);
							shapes.stroke();
							shapes.closePath();
							enemies[i].cooldown++;
							if(enemies[i].health <= 50) {
								if(enemies[i].cooldown >= 20) {
									enemies.push(new Crasher(x,y,0,0));
									enemies[i].cooldown = 0;
								}
							} else {
								if(enemies[i].cooldown >= 100) {
									enemies[i].cooldown = 0;
									var type = Math.random()*3;
									if(type <= 1) {
										for(var j = 1; j <= 9; j++) {
										
											if(j === 1) {
												enemies.push(new Crasher(x-20,y-20,0,0));
											}
											if(j === 2) {
												enemies.push(new Crasher(x,y-20,0,0));
											}
											if(j === 3) {
												enemies.push(new Crasher(x+20,y-20,0,0));
											}
											if(j === 4) {
												enemies.push(new Crasher(x-20,y,0,0));
											}
											if(j === 5) {
												enemies.push(new Crasher(x,y,0,0));
											}
											if(j === 6) {
												enemies.push(new Crasher(x+20,y,0,0));
											}
											if(j === 7) {
												enemies.push(new Crasher(x-20,y+20,0,0));
											}
											if(j === 8) {
												enemies.push(new Crasher(x,y+20,0,0));
											}
											if(j === 9) {
												enemies.push(new Crasher(x+20,y+20,0,0));
											};
										}
									} else if(type <= 2 && type > 1) {
										enemies.push(new BigCrasher(x,y,0,0));
									} else if(type <= 3 && type > 2) {
										enemies.push(new Splitter(x,y,0,0));
									}
								}
							}
						}
						playerCollision(i);
					}
				}
				document.getElementById("lives").innerHTML = "Lives: " + player.lives;
				document.getElementById("wave number").innerHTML = "Wave: " + wavenum;
				if(player.lives <= 0) {
					theGame.stop();
					theGame.clear();
					shapes.fillText("you died lol",175,200);
					
				}
				
			}
			
			const playerCollision = (e) => {
				if(
					player.xPos - 10 < enemies[e].xPos + enemies[e].hitbox &&
					player.xPos + 10 > enemies[e].xPos - enemies[e].hitbox &&
					player.yPos - 10 < enemies[e].yPos + enemies[e].hitbox &&
					player.yPos + 10 > enemies[e].yPos - enemies[e].hitbox
				) {
					enemies[e].health -= 5;
					player.lives--;
					if(enemies[e].health <= 0) {
						enemies[e].dead = true;
					}
				}
			}
			const wave = () => {
				wavenum++;
				if(wavenum != 15) {
					let crashers = Math.random() * 3 + 1;
					for(crashers; crashers > 0; crashers--) {
						let side = Math.random() * 4 + 1;
						if (side >= 1 && side < 2) {
							enemies.push(new Crasher(0,Math.random()*400,0,0));
						}
						if (side >= 2 && side < 3) {
							enemies.push(new Crasher(400,Math.random()*400,0,0));
						}
						if (side >= 3 && side < 4) {
							enemies.push(new Crasher(Math.random()*400,0,0,0));
						}
						if (side >= 4) {
							enemies.push(new Crasher(Math.random()*400,400,0,0));
						}
					}
				}
				if(wavenum >= 5) {
					let bigcrashers = Math.random() * 2;
					for(bigcrashers; bigcrashers > 0; bigcrashers--) {
						let side = Math.random() * 4 + 1;
						if (side >= 1 && side < 2) {
							enemies.push(new BigCrasher(0,Math.random()*400,0,0));
						}
						if (side >= 2 && side < 3) {
							enemies.push(new BigCrasher(400,Math.random()*400,0,0));
						}
						if (side >= 3 && side < 4) {
							enemies.push(new BigCrasher(Math.random()*400,0,0,0));
						}
						if (side >= 4) {
							enemies.push(new BigCrasher(Math.random()*400,400,0,0));
						}
					}
				}
				if(wavenum >= 10 && wavenum != 15) {
					let splitters = Math.random() * 2;
					for(splitters; splitters > 0; splitters--) {
						let side = Math.random() * 4 + 1;
						if (side >= 1 && side < 2) {
							enemies.push(new Splitter(0,Math.random()*400,0,0));
						}
						if (side >= 2 && side < 3) {
							enemies.push(new Splitter(400,Math.random()*400,0,0));
						}
						if (side >= 3 && side < 4) {
							enemies.push(new Splitter(Math.random()*400,0,0,0));
						}
						if (side >= 4) {
							enemies.push(new Splitter(Math.random()*400,400,0,0));
						}
					}
				}
				if(wavenum === 15) {
					enemies.push(new SpawnerBoss(0,200,0,0));
					
				}
				player.damage += 0.2;
				player.reload *= 19/20;
				if(wavenum % 5 === 0) {
					player.lives++;
				}
			}
			
		</script>
	</body>
</html>
